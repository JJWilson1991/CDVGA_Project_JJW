---
title: "ExploratoryAnalysis"
author: "JJWilson"
date: "11/10/2019"
output: html_document
---

#Load the required libraries 



```{r}

library(readxl)

library(dplyr)

library(tidyverse)

library(forcats)

library(ggthemes)

library(plotly)

library(knitr)

library(naniar)

library(ggplot2)

library(maps)

library(ggmap)

library(maptools)

library(sf)

```



#Load the processed data from the RDS



```{r}

CDV_Clean <-   readRDS("../../data/processed_data/CDVprocesseddata.rds")



glimpse(CDV_Clean)

```
```{r}
#The data we are most interested in is the Species data over time and the area data over time so we'll begin by exploring these

Species_freq <- ggplot(CDV_Clean, aes(Species, fill=Species, color=Species)) +geom_bar()  +
theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8), legend.position = "none")

Species_freq

ggsave(filename = "../../results/Species_freq.png",plot = Species_freq)
#we can see that Raccoon and Gray fox are hugely over represented compared to the others so we should focus our analysis on these two species
```
```{r}
library(RColorBrewer)
#are there any obvious differneces in species by state?
Species_by_state <- ggplot(CDV_Clean, aes(Species, fill=Species, color=Species)) +
geom_bar()   + 
theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8), legend.position = "none") +facet_wrap( ~ State)

Species_by_state

ggsave(filename = "../../results/Species_by_state.png",plot = Species_by_state)
```
```{r}
raccoongrayfox <- subset(CDV_Clean, Species %in% c("Raccoon", "Gray Fox"))
SPperYr <- with(raccoongrayfox, table(Species, CollectionYear))
RacFox_year<- ggplot(as.data.frame(SPperYr), aes(CollectionYear, Freq, fill = Species, color = Species, group = Species))  + 
  geom_point() +geom_line() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))

RacFox_year <- ggplotly(RacFox_year)
RacFox_year 

#ggsave(filename = "../../results/RacFox_year.png",plot = RacFox_year)
#looking overtime there appears to be some patterns in the number of postive cases, with definite peaks possibly relating to epizootics of CDV
#It also looks like there may be a delay in the Gray Fox peak following the peak in Raccoons, this is worth looking into
#Would be good to run a time series analysis on this data to see if peaks in raccoon cases are predicitive of grayfox peaks
```

```{r}
RacFoxTest<- ggplot(as.data.frame(SPperYr), aes(CollectionYear, Freq, fill = Species, color = Species, group = Species))  + 
  geom_point() +geom_line() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))
tr <- ggplotly(RacFoxTest)
```

```{r}
State_freq <- ggplot(CDV_Clean, aes(State, fill=State, color=State)) +geom_bar() + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8), legend.position = "none")

State_freq

ggsave(filename = "../../results/State_freq.png",plot = State_freq)
#GA is the majority of cases which is understandable as SCWDS is in Athens, but there are enough cases in other south eastern states to possibly gain some insight
#but i think the bulk of the mapping should focus on the county data within GA

```
```{r}
State_wrap_species <- ggplot(CDV_Clean, aes(State, fill=State, color=State)) +geom_bar() + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8), legend.position = "none") + 
  facet_wrap(~Species)

State_wrap_species

ggsave(filename = "../../results/State_wrap_species.png",plot = State_wrap_species)
```
```{r}
StperYr <- with(CDV_Clean, table(State, CollectionYear))
point_casesyear_state <- ggplot(as.data.frame(StperYr), aes(CollectionYear, Freq, fill = State, color = State, group = State))  + 
  geom_point() +
  geom_line() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))

point_casesyear_state

ggsave(filename = "../../results/point_casesyear_state.png",plot = point_casesyear_state)
#the cases per state over time seem to follow a similar pattern but it may be worth plotting species cases per state and mapping location, maybe certain species are more affected in different states at different times?


```

```{r}
#we're basically repaeting the above but including species to see if this varies by state
SPYRST <- with(CDV_Clean, table(State, CollectionYear, Species))
point_casesyear_state_wrap_species <-    ggplot(as.data.frame(SPYRST), aes(CollectionYear, Freq, fill = State, color = State, group = State))  +
  geom_point() +geom_line() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) + 
  facet_wrap( ~ Species)

point_casesyear_state_wrap_species

ggsave(filename = "../../results/point_casesyear_state_wrap_species.png",plot = point_casesyear_state_wrap_species)

#the number of cases in species other than gray fox and raccon is so low its probably better to just focus on those 2 species gping forward
```
```{r}
SP_Fr_Yr_WrapState <- ggplot(as.data.frame(SPYRST), aes(CollectionYear, Freq, fill = Species, color = Species, group = Species))  + 
  geom_point() +
  geom_line() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) + 
  facet_wrap( ~ State)

SP_Fr_Yr_WrapState

ggsave(filename = "../../results/SP_Fr_Yr_WrapState.png",plot = SP_Fr_Yr_WrapState)


#there does seem to be a little bit of variation here between state over time, maybe theyre epidemics spreading from a nidus? worth investigating in maps
```

```{r}
#lets take a look if there is any obvious variation in ages affected between raccoon and  gray fox
RGFAge <- subset(CDV_Clean, Species %in% c("Raccoon", "Gray Fox") & Age %in% c("Adult", "Subadult", "Juvenile"))
RacFox_Age <- ggplot(RGFAge, aes(Species, color=Species)) +geom_bar(aes(fill = Age))

RacFox_Age

ggsave(filename = "../../results/RacFox_Age.png",plot = RacFox_Age)
#there may be something here, worth looking at statistically going forward
```
```{r}
tib <-  as.data.frame(with(RGFAge, table(Age, Species)))
          
TibageSP <- tib %>% spread(key = Age, value = Freq)
TibageSPd <- TibageSP%>% dplyr::mutate(Total = (Adult + Subadult +Juvenile))

tb<- TibageSPd %>% mutate_at(vars(Adult, Juvenile, Subadult), funs(./Total))
tb

```

```{r}
#i forgot to plot age by species wrap.. its pretty uninteresting

ggplot(CDV_Clean, aes(Sex)) + geom_bar() +facet_wrap(~Species)
```
```{r}
RGFSex <- subset(CDV_Clean, Species %in% c("Raccoon", "Gray Fox") & Sex %in% c("Male", "Female"))

RacFox_Sex <- ggplot(RGFSex, aes(Sex)) + 
  geom_bar() +
  facet_wrap(~Species)
RacFox_Sex

ggsave(filename = "../../results/RacFox_Sex.png",plot = RacFox_Sex)
# There may be a significant difference in the M/F distribution for gray foxes, worth analsing
```
```{r}
#as there seemed to potnetially be some difference in gender distribution, lets look at gender difference over time between raccoon and gray fox
#ceratinly in the earlier time frame there seems to be more female gray foxes affected, has this got a role in why there were many fewer cases after this as population has fallen?
RGFSEXYEAR<- with(RGFSex, table(Species, CollectionYear, Sex))
Gender_year <- ggplot(as.data.frame(RGFSEXYEAR), aes(CollectionYear, Freq, fill = Sex, color = Sex, group = Sex))  + 
  geom_point() +geom_line() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) + facet_wrap(~Species)

Gender_year
```

```{r}
#If we quickly plot a histogram using latitude it suggest there are some geographic differences in distribution 
LAT <- left_join(GAC, CDVGA2, by= "County") %>% subset( Species %in% c("Raccoon", "Gray Fox"))

ggplot(LAT, aes(lat)) + geom_histogram()  +
 facet_wrap(~Species)

#This is interesting, there are two disticnt latitudinal peaks for raccoons but only 1 for gray foxes
```

```{r}
#bivariate mosaic plot of Sex and species
SexSpecies_Mosaic <- ggplot(RGFSex) +geom_mosaic(aes(x=product(Sex, Species), fill=Sex))

SexSpecies_Mosaic

ggsave(filename = "../../results/SexSpecies_Mosaic.png",plot = SexSpecies_Mosaic)
```

```{r}
#Bivariate of Age and Species
ggplot(RGFSex) +geom_mosaic(aes(x=product(Age, Species), fill=Age), na.rm = TRUE)
#The age measurement is too subjective to read much into really, also depends on reproductive strategy and life history of species... are there more offspring? are they hidden?

```
```{r}

RGFSex %>% crosstab(Species, Sex, Age, percentages  = TRUE)

```
```{r}
RGFSex %>% crosstab(Species, Sex, chi_square =  TRUE)

```
```{r}
RGFSex %>% crosstab(Species, Age, chi_square =  TRUE)

```